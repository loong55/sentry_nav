  <?xml version="1.0" encoding="UTF-8"?>
  <root BTCPP_format="4">
    <BehaviorTree ID="check_energy">
      <Fallback>
        <IsEnergyEnough remaining_energy="20" key_port="{@referee_buff}"/>
        <ForceFailure>
          <Sequence>
            <PubNav2Goal goal="1.5;0;0" topic_name="goal_pose"/>
            <IsRfidDetected friendly_supply_zone_non_exchange="true" key_port="{@referee_rfidStatus}"/>
            <Fallback>
              <Sequence>
                <IsGameStatus min_remain_time="0" max_remain_time="239" 
                            expected_game_progress="4" key_port="{@referee_gameStatus}"/>
                <PubNav2Goal goal="1.0;0;0" topic_name="goal_pose"/>
              </Sequence>
              <ForceSuccess>
                <PubNav2Goal goal="6.5;0.5;0" topic_name="goal_pose"/>
              </ForceSuccess>
            </Fallback>
          </Sequence>
        </ForceFailure>
      </Fallback>
    </BehaviorTree>
    <BehaviorTree ID="check_robot_status">
      <Fallback>
        <IsStatusOK ammo_min="20" heat_max="500" hp_min="200" key_port="{@referee_robotStatus}"/>
        <ForceFailure>
          <Sequence>
            <PubNav2Goal goal="0.5;0;0" topic_name="goal_pose"/>
            <IsRfidDetected friendly_supply_zone_non_exchange="true" key_port="{@referee_rfidStatus}"/>
            <IsStatusOK ammo_min="20" heat_max="500" hp_min="399" key_port="{@referee_robotStatus}"/>
            <Fallback>
              <Sequence>
                <IsGameStatus min_remain_time="0" max_remain_time="239" 
                            expected_game_progress="4" key_port="{@referee_gameStatus}"/>
                <PubNav2Goal goal="4.0;-1.0;0" topic_name="goal_pose"/>
              </Sequence>
              <ForceSuccess>
                <PubNav2Goal goal="6.5;0.5;0" topic_name="goal_pose"/>
              </ForceSuccess>
            </Fallback>
          </Sequence>
        </ForceFailure>
      </Fallback>
    </BehaviorTree>
    <BehaviorTree ID="first_3_minutes">
      <Sequence>
        <IsGameStatus min_remain_time="240" max_remain_time="420" 
                    expected_game_progress="4" key_port="{@referee_gameStatus}"/>
        <PubNav2Goal goal="2;0;0" topic_name="goal_pose"/>
        <ReactiveSequence>
          <IsRfidDetected enemy_central_highland_gain_point="true" key_port="{@referee_rfidStatus}"/>
          <ForceFailure>
            <PubNav2Goal goal="2;0;0" topic_name="goal_pose"/>
          </ForceFailure>
          <PublishSpinSpeed spin_speed="1" topic_name="cmd_spin"/>
        </ReactiveSequence>
      </Sequence>
    </BehaviorTree>
    <BehaviorTree ID="last_4_minutes">
      <Sequence>
        <IsGameStatus min_remain_time="0" max_remain_time="239" 
                    expected_game_progress="4" key_port="{@referee_gameStatus}"/>
        <PubNav2Goal goal="1.0;0;0" topic_name="goal_pose"/>
      </Sequence>
    </BehaviorTree>

    <!-- ================================= 主行为树 ================================= -->
    <BehaviorTree ID="fjut">
      <KeepRunningUntilFailure>
        <ForceSuccess>
          <ReactiveSequence>
            <IsGameStatus min_remain_time="0" max_remain_time="420" 
                          expected_game_progress="4" key_port="{@referee_gameStatus}"/>
            <Sequence>
              <SubTree ID="check_energy"/>
              <SubTree ID="check_robot_status"/>
              <Fallback>
                <SubTree ID="check_robot_status"/>
                <SubTree ID="first_3_minutes"/>
                <SubTree ID="last_4_minutes"/>
              </Fallback>
            </Sequence>
          </ReactiveSequence>
        </ForceSuccess>
      </KeepRunningUntilFailure>
    </BehaviorTree>

      <TreeNodesModel>
          <Condition ID="IsEnergyEnough">
              <input_port name="remaining_energy" type="int" default="20">剩余能量</input_port>
              <input_port name="key_port" type="pb_rm_interfaces::msg::Buff_&lt;std::allocator&lt;void&gt; &gt;" default="{@referee_buff}">Buff port on blackboard</input_port>
          </Condition>
          <Condition ID="IsGameStatus">
              <input_port name="max_remain_time" type="int" default="420">Maximum remaining time (s)</input_port>
              <input_port name="min_remain_time" type="int" default="0">Minimum remaining time (s)</input_port>
              <input_port name="expected_game_progress" type="int" default="4">Expected game progress stage</input_port>
              <input_port name="key_port" type="pb_rm_interfaces::msg::GameStatus_&lt;std::allocator&lt;void&gt; &gt;" default="{@referee_gameStatus}">GameStatus port on blackboard</input_port>
          </Condition>
          <Condition ID="IsRfidDetected">
              <input_port name="enemy_central_highland_gain_point" type="bool" default="false">对方中央高地增益点</input_port>
              <input_port name="friendly_supply_zone_exchange" type="bool" default="false">己方与兑换区重叠的补给区</input_port>
              <input_port name="friendly_supply_zone_non_exchange" type="bool" default="false">己方与兑换区不重叠的补给区 / RMUL 补给区</input_port>
              <input_port name="friendly_fortress_gain_point" type="bool" default="false">己方堡垒增益点</input_port>
              <input_port name="key_port" type="pb_rm_interfaces::msg::RfidStatus_&lt;std::allocator&lt;void&gt; &gt;" default="{@referee_rfidStatus}">RfidStatus port on blackboard</input_port>
          </Condition>
          <Condition ID="IsStatusOK">
              <input_port name="ammo_min" type="int" default="0">Lower then minimum ammo will return FAILURE</input_port>
              <input_port name="heat_max" type="int" default="350">Maximum heat. NOTE: Sentry heat limit is 400</input_port>
              <input_port name="hp_min" type="int" default="300">Minimum HP. NOTE: Sentry init/max HP is 400</input_port>
              <input_port name="key_port" type="pb_rm_interfaces::msg::RobotStatus_&lt;std::allocator&lt;void&gt; &gt;" default="{@referee_robotStatus}">RobotStatus port on blackboard</input_port>
          </Condition>
          <Condition ID="PubNav2Goal">
              <input_port name="goal" type="geometry_msgs::msg::PoseStamped_&lt;std::allocator&lt;void&gt; &gt;" default="0;0;0">Expected goal pose that send to nav2. Fill with format `x;y;yaw`</input_port>
              <input_port name="topic_name" type="std::string" default="__default__placeholder__">Topic name</input_port>
          </Condition>
          <Action ID="PublishSpinSpeed">
              <input_port name="spin_speed" type="int" default="0">Angular Z velocity (rad/s)</input_port>
              <input_port name="duration" type="std::chrono::milliseconds" default="">Publish then sleep duration in milliseconds</input_port>
              <input_port name="topic_name" type="std::string" default="cmd_spin">Topic name</input_port>
          </Action>
          <Action ID="PublishTwist">
              <input_port name="v_y" type="double" default="0.000000">Linear Y velocity (m/s)</input_port>
              <input_port name="v_yaw" type="double" default="0.000000">Angular Z velocity (rad/s)</input_port>
              <input_port name="v_x" type="double" default="0.000000">Linear X velocity (m/s)</input_port>
              <input_port name="duration" type="std::chrono::milliseconds" default="">Publish then sleep duration in milliseconds</input_port>
              <input_port name="topic_name" type="std::string" default="__default__placeholder__">Topic name</input_port>
          </Action>
      </TreeNodesModel>
  </root>