<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4">
  <!-- ========================= 子行为树 ========================= -->
  <!-- 检测比赛是否开始 -->
  <BehaviorTree ID="check_game_started">
    <IsGameStatus min_remain_time="0" max_remain_time="420" 
                  expected_game_progress="4" key_port="{@referee_gameStatus}"/>
  </BehaviorTree>

  <!-- 能量不足时返回补给区 -->
  <BehaviorTree ID="return_to_supply_on_low_energy">
    <Fallback>
      <IsEnergyEnough remaining_energy="15" key_port="{@referee_buff}"/>
        <ForceFailure>
          <PubNav2Goal goal="2.8;-0.2;0" topic_name="goal_pose"/>  <!-- 补给区坐标 -->
        </ForceFailure>
    </Fallback>
  </BehaviorTree>

  <!-- 状态异常时返回补给区 -->
  <BehaviorTree ID="return_to_supply_on_bad_status">
    <Fallback>
      <IsStatusOK ammo_min="40" heat_max="500" hp_min="200" key_port="{@referee_robotStatus}"/>
      <Sequence>
          <PubNav2Goal goal="-1;-5.35;0" topic_name="goal_pose"/>  <!-- 补给区坐标 -->
          <IsStatusOK ammo_min="20" heat_max="500" hp_min="399" key_port="{@referee_robotStatus}"/>
      </Sequence>
    </Fallback>
  </BehaviorTree>

  <!-- 前三分钟策略：攻占中央高地 -->
  <BehaviorTree ID="attack_outpost">
    <Sequence>
      <IsGameStatus min_remain_time="350" max_remain_time="420"
                    expected_game_progress="4" key_port="{@referee_gameStatus}"/>
      <PubNav2Goal goal="11.75;1.25;0" topic_name="goal_pose"/>
      <!-- <PubNav2Goal goal="12.3;-3.35;0" topic_name="goal_pose"/> -->
      <ReactiveSequence>
        <IsRfidDetected enemy_central_highland_gain_point="true" key_port="{@referee_rfidStatus}"/>
        <PublishSpinSpeed spin_speed="1" topic_name="cmd_spin"/>  <!-- 到达后旋转防御 -->
      </ReactiveSequence>
    </Sequence>
  </BehaviorTree>
  <BehaviorTree ID="attack_central_highland">
    <Sequence>
      <IsGameStatus min_remain_time="290" max_remain_time="349"
                    expected_game_progress="4" key_port="{@referee_gameStatus}"/>
      <PubNav2Goal goal="8;-4.5;0" topic_name="goal_pose"/>
      <!-- <PubNav2Goal goal="12.3;-3.35;0" topic_name="goal_pose"/> -->
      <ReactiveSequence>
        <IsRfidDetected enemy_central_highland_gain_point="true" key_port="{@referee_rfidStatus}"/>
        <PublishSpinSpeed spin_speed="1" topic_name="cmd_spin"/>  <!-- 到达后旋转防御 -->
      </ReactiveSequence>
    </Sequence>
  </BehaviorTree>
  <!-- 后四分钟策略：返回堡垒 -->
  <BehaviorTree ID="defend_fortress">
    <Sequence>
      <IsGameStatus min_remain_time="0" max_remain_time="289" 
                    expected_game_progress="4" key_port="{@referee_gameStatus}"/>
      <!-- <IsStatusOK ammo_min="120" heat_max="500" hp_min="200" key_port="{@referee_robotStatus}"/> -->
      <!-- <PubNav2Goal goal="2.8;-0.2;0" topic_name="goal_pose"/>  堡垒坐标 -->
      <PubNav2Goal goal="3.5;-2;0" topic_name="goal_pose"/>
    </Sequence>
  </BehaviorTree>

  <!-- ========================= 主行为树 ========================= -->
  <BehaviorTree ID="test">
    <KeepRunningUntilFailure>
      <ForceSuccess>
        <ReactiveSequence>
          <!-- 1. 检查比赛是否开始 -->
          <SubTree ID="check_game_started"/>
          <!-- 2. 持续监控能量和状态 -->
          <Parallel success_count="2" failure_count="1">
            <SubTree ID="return_to_supply_on_low_energy"/>
            <SubTree ID="return_to_supply_on_bad_status"/>
          </Parallel>
          <!-- 3. 分阶段执行策略 -->
          <Fallback>
            <SubTree ID="attack_outpost"/>
            <SubTree ID="attack_central_highland"/>  <!-- 前三分钟 -->
            <SubTree ID="defend_fortress"/>         <!-- 后四分钟 -->
          </Fallback>
        </ReactiveSequence>
      </ForceSuccess>
    </KeepRunningUntilFailure>
  </BehaviorTree>
  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Condition ID="IsEnergyEnough">
      <input_port name="remaining_energy"
                  default="20"
                  type="int">底盘剩余能量</input_port>
      <input_port name="key_port"
                  default="{@referee_buff}"
                  type="pb_rm_interfaces::msg::Buff_&lt;std::allocator&lt;void&gt; &gt;">Buff port on blackboard</input_port>
    </Condition>
    <Condition ID="IsRfidDetected">
      <input_port name="friendly_supply_zone_exchange"
                  default="false"
                  type="bool">己方与兑换区重叠的补给区</input_port>
      <input_port name="friendly_supply_zone_non_exchange"
                  default="false"
                  type="bool">己方与兑换区不重叠的补给区 / RMUL 补给区</input_port>
      <input_port name="enemy_central_highland_gain_point"
                  default="false"
                  type="bool">对方中央高地增益区</input_port>
      <input_port name="friendly_fortress_gain_point"
                  default="false"
                  type="bool">己方堡垒增益点</input_port>
      <input_port name="key_port"
                  default="{@referee_rfidStatus}"
                  type="pb_rm_interfaces::msg::RfidStatus_&lt;std::allocator&lt;void&gt; &gt;">RfidStatus port on blackboard</input_port>
    </Condition>
    <Condition ID="IsGameStatus">
      <input_port name="max_remain_time"
                  default="420"
                  type="int">Maximum remaining time (s)</input_port>
      <input_port name="min_remain_time"
                  default="0"
                  type="int">Minimum remaining time (s)</input_port>
      <input_port name="expected_game_progress"
                  default="4"
                  type="int">Expected game progress stage</input_port>
      <input_port name="key_port"
                  default="{@referee_gameStatus}"
                  type="pb_rm_interfaces::msg::GameStatus_&lt;std::allocator&lt;void&gt; &gt;">GameStatus port on blackboard</input_port>
    </Condition>
    <Condition ID="ISATKOP">
      <input_port name="op_hp"
                  default="0"
                  type="int">前哨血量</input_port>
      <input_port name="key_port"
                  default="{@referee_allRobotHP}"
                  type="pb_rm_interfaces::msg::GameRobotHp_&lt;std::allocator&lt;void&gt; &gt;">GameRobotHp port on blackboard</input_port>
    </Condition>
    <Condition ID="IsStatusOK">
      <input_port name="ammo_min"
                  default="0"
                  type="int">Lower then minimum ammo will return FAILURE</input_port>
      <input_port name="heat_max"
                  default="350"
                  type="int">Maximum heat. NOTE: Sentry heat limit is 400</input_port>
      <input_port name="hp_min"
                  default="300"
                  type="int">Minimum HP. NOTE: Sentry init/max HP is 400</input_port>
      <input_port name="key_port"
                  default="{@referee_robotStatus}"
                  type="pb_rm_interfaces::msg::RobotStatus_&lt;std::allocator&lt;void&gt; &gt;">RobotStatus port on blackboard</input_port>
    </Condition>
    <Condition ID="PubNav2Goal">
      <input_port name="goal"
                  default="0;0;0"
                  type="geometry_msgs::msg::PoseStamped_&lt;std::allocator&lt;void&gt; &gt;">Expected goal pose that send to nav2. Fill with format `x;y;yaw`</input_port>
      <input_port name="topic_name"
                  default="__default__placeholder__"
                  type="std::string">Topic name</input_port>
    </Condition>
    <Action ID="PublishSpinSpeed">
      <input_port name="spin_speed"
                  default="0"
                  type="int">Angular Z velocity (rad/s)</input_port>
      <input_port name="duration"
                  type="std::chrono::milliseconds">Publish then sleep duration in milliseconds</input_port>
      <input_port name="topic_name"
                  default="__default__placeholder__"
                  type="std::string">Topic name</input_port>
    </Action>
    <Action ID="PublishTwist">
      <input_port name="v_y"
                  default="0.000000"
                  type="double">Linear Y velocity (m/s)</input_port>
      <input_port name="v_yaw"
                  default="0.000000"
                  type="double">Angular Z velocity (rad/s)</input_port>
      <input_port name="v_x"
                  default="0.000000"
                  type="double">Linear X velocity (m/s)</input_port>
      <input_port name="duration"
                  type="std::chrono::milliseconds">Publish then sleep duration in milliseconds</input_port>
      <input_port name="topic_name"
                  default="__default__placeholder__"
                  type="std::string">Topic name</input_port>
    </Action>
  </TreeNodesModel>

</root>
